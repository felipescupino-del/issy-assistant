---
phase: 03-insurance-qa-handoff
plan: "02"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/services/conversation.ts
  - src/services/handoff.ts
  - src/services/admin.ts
  - src/routes/webhook.ts
autonomous: true
requirements: [HAND-01, HAND-02, HAND-03]

must_haves:
  truths:
    - "Broker sends /humano and bot sends a structured briefing message to the same chat before going silent"
    - "After handoff, bot does not respond to any broker messages until admin restores control"
    - "Admin sends /bot from allowlisted phone and bot resumes responding in that conversation"
    - "Admin sends /status from allowlisted phone and receives current mode, broker name, and last message"
    - "Non-admin phone sending /bot or /status gets no response (treated as normal message that is ignored)"
    - "Briefing message contains broker name, phone, last 3 user messages, and /bot instructions"
  artifacts:
    - path: "src/services/conversation.ts"
      provides: "setHumanMode function to toggle humanMode on conversation"
      exports: ["setHumanMode"]
    - path: "src/services/handoff.ts"
      provides: "buildHandoffBriefing and executeHandoff functions"
      exports: ["buildHandoffBriefing", "executeHandoff"]
    - path: "src/services/admin.ts"
      provides: "isAdminPhone, isAdminCommand, handleAdminCommand functions"
      exports: ["isAdminPhone", "isAdminCommand", "handleAdminCommand"]
    - path: "src/routes/webhook.ts"
      provides: "Updated pipeline with admin command check before humanMode gate and handoff branch after intent classification"
  key_links:
    - from: "src/routes/webhook.ts"
      to: "src/services/admin.ts"
      via: "isAdminCommand(text) check before humanMode gate"
      pattern: "isAdminCommand.*handleAdminCommand"
    - from: "src/routes/webhook.ts"
      to: "src/services/handoff.ts"
      via: "intent === 'handoff' branch calls executeHandoff()"
      pattern: "intent.*handoff.*executeHandoff"
    - from: "src/services/handoff.ts"
      to: "src/services/conversation.ts"
      via: "executeHandoff calls setHumanMode(phone, true) after sending briefing"
      pattern: "setHumanMode.*true"
    - from: "src/services/admin.ts"
      to: "src/services/conversation.ts"
      via: "handleAdminCommand /bot calls setHumanMode(phone, false)"
      pattern: "setHumanMode.*false"
---

<objective>
Implement human handoff flow and admin commands so the bot can transfer conversations to a human agent with structured context and be controlled via in-band WhatsApp commands.

Purpose: HAND-01 (handoff transfer), HAND-02 (structured briefing), HAND-03 (admin commands /bot, /status, /humano) — the broker types /humano and the bot sends a briefing then goes silent; admin types /bot to restore bot mode; admin types /status to see conversation state.

Output: `src/services/handoff.ts` (NEW), `src/services/admin.ts` (NEW), updated `src/services/conversation.ts` (setHumanMode), updated `src/routes/webhook.ts` (pipeline rewiring).
</objective>

<execution_context>
@/Users/felipescupino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felipescupino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-insurance-qa-handoff/03-RESEARCH.md
@.planning/phases/03-insurance-qa-handoff/03-01-SUMMARY.md

@src/services/conversation.ts
@src/services/whatsapp.ts
@src/services/history.ts
@src/services/contact.ts
@src/services/intent.ts
@src/routes/webhook.ts
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setHumanMode, handoff service, and admin service</name>
  <files>src/services/conversation.ts, src/services/handoff.ts, src/services/admin.ts</files>
  <action>
1. Update `src/services/conversation.ts` — add `setHumanMode` function after the existing `isHumanMode`:

```typescript
/**
 * Set humanMode for a conversation. Used by handoff flow (true) and admin /bot command (false).
 * Uses update (not upsert) because getOrCreateConversation always runs first in the pipeline.
 */
export async function setHumanMode(phone: string, mode: boolean): Promise<void> {
  await prisma.conversation.update({
    where: { phone },
    data: { humanMode: mode },
  });
}
```

2. Create `src/services/handoff.ts` with two exports:

a. `buildHandoffBriefing(contact, history)` — a DETERMINISTIC template function (no GPT call). Takes contact `{ name: string; phone: string }` and history `Array<{ role: string; content: string }>`. Returns a formatted WhatsApp message string:

```
*TRANSFERENCIA PARA ATENDIMENTO HUMANO*

*Corretor:* {name} ({phone})
*Mensagens anteriores:* {history.length}

*Ultimas mensagens do corretor:*
{last 3 user messages as bullet points, each truncated to 120 chars}

Para retornar ao bot: envie */bot* neste chat
```

Note: Use WhatsApp bold markdown (`*text*`). Do NOT use emojis — keep it professional per KNOW-04 tone. Filter history to `role === 'user'` and take `.slice(-3)`.

b. `executeHandoff(phone, contact, history)` — orchestrates the handoff in STRICT order:
   1. Build briefing (pure, no side effects)
   2. Send briefing via `sendTextMessage(phone, briefing)` — NO typing delay for system messages (use `delayTypingSeconds=0` or omit)
   3. Set humanMode=true via `setHumanMode(phone, true)` — AFTER send succeeds
   4. Build confirmation message: `"Entendido, {contact.name}! Estou transferindo para um especialista da assessoria. Eles vao ver todo o contexto da conversa e entrar em contato em breve."`
   5. Send confirmation via `sendTextMessage(phone, confirmation, 1)` — short 1s delay
   6. Save briefing to history: `saveMessage(phone, 'assistant', briefing)` — AFTER send succeeds
   7. Save confirmation to history: `saveMessage(phone, 'assistant', confirmation)` — AFTER send succeeds

Import from: `../services/whatsapp` (sendTextMessage), `../services/conversation` (setHumanMode), `../services/history` (saveMessage).

**CRITICAL ORDERING:** Steps 2 before 3 (briefing sent before bot goes silent). Steps 6-7 after 2 and 5 (save after send — same pattern as Phase 2 webhook.ts).

3. Create `src/services/admin.ts` with three exports:

a. `isAdminPhone(phone: string): boolean` — checks `config.admin.phoneNumbers.includes(phone)`. Import config from `../config`.

b. `isAdminCommand(text: string): boolean` — checks if text is EXACTLY `/bot` or `/status` (trimmed, lowercased). Returns false for `/humano` — that goes through normal intent pipeline. Returns false for anything else.

c. `handleAdminCommand(phone: string, text: string): Promise<void>` — handles:

For `/bot`:
- Call `setHumanMode(phone, false)`
- Send confirmation: `"Bot mode restaurado. Issy voltou a responder neste chat."` via sendTextMessage (no typing delay)
- Log: `[admin] /bot executed by {phone}`

For `/status`:
- Query conversation: `prisma.conversation.findUnique({ where: { phone } })`
- Query contact: `prisma.contact.findUnique({ where: { phone } })`
- Query last message: `prisma.message.findFirst({ where: { phone }, orderBy: { createdAt: 'desc' } })`
- Build status message:
```
*Status do Chat*
Modo: {humanMode ? 'Humano' : 'Bot'}
Corretor: {contact.name ?? 'Desconhecido'}
Ultima mensagem: "{lastMessage.content truncated to 100 chars}"
```
- Send via sendTextMessage (no typing delay)
- Log: `[admin] /status executed by {phone}`

Import from: `../config` (config), `../services/conversation` (setHumanMode), `../services/whatsapp` (sendTextMessage), `../lib/prisma` (prisma).
  </action>
  <verify>
    <automated>npx tsc --noEmit --skipLibCheck 2>&1 | head -20</automated>
    <manual>Inspect conversation.ts has setHumanMode, handoff.ts has buildHandoffBriefing + executeHandoff, admin.ts has isAdminPhone + isAdminCommand + handleAdminCommand</manual>
  </verify>
  <done>
- `setHumanMode(phone, mode)` updates conversation.humanMode in the database
- `buildHandoffBriefing` returns a deterministic formatted string with broker info and last 3 user messages
- `executeHandoff` sends briefing, sets humanMode=true, sends confirmation, saves both to history — in that exact order
- `isAdminPhone` checks against config.admin.phoneNumbers
- `isAdminCommand` returns true only for /bot and /status (not /humano)
- `handleAdminCommand` handles /bot (restore bot) and /status (show state)
- TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire admin commands and handoff into webhook pipeline</name>
  <files>src/routes/webhook.ts</files>
  <action>
Update `src/routes/webhook.ts` to add two new branches to the `processMessage()` function. This builds on top of the webhook.ts state from Plan 03-01 (which added detectProductType and productType parameter).

1. Add imports at the top (alongside existing imports):
```typescript
import { isAdminCommand, isAdminPhone, handleAdminCommand } from '../services/admin';
import { executeHandoff } from '../services/handoff';
```

2. Restructure `processMessage()` to add admin command check and handoff branch. The new pipeline order is:

```
Step 1: Parse payload + guard (UNCHANGED)
Step 2: Persist contact (UNCHANGED)
Step 3: NEW — Admin command check (BEFORE human mode gate)
Step 4: Human mode gate (was Step 2 in Phase 2, now Step 4)
Step 5: Classify intent (was Step 3)
Step 6: NEW — Handoff branch (if intent === 'handoff', execute handoff and return)
Step 7: Load history (was Step 4)
Step 8: Save user message (was Step 5)
Step 9: Detect product type (added by 03-01)
Step 10: Generate AI response (was Step 6)
Step 11: Send response (was Step 7)
Step 12: Save assistant response (was Step 8)
```

**Step 3 — Admin command check (new):**
```typescript
// Step 3: Admin command check — BEFORE human mode gate (HAND-03)
// /bot must work even when humanMode=true (otherwise deadlock — can't restore bot)
// Only /bot and /status are admin commands. /humano flows through normal intent pipeline.
if (isAdminCommand(text)) {
  if (isAdminPhone(phone)) {
    await handleAdminCommand(phone, text);
  }
  // Non-admin sending /bot or /status: silently ignore (no response, no processing)
  return;
}
```

**Step 6 — Handoff branch (new):**
After intent classification, before loading history for Q&A:
```typescript
// Step 6: Handoff branch — exit pipeline, bot goes silent (HAND-01, HAND-02)
if (intent === 'handoff') {
  const history = await loadHistory(phone);
  await saveMessage(phone, 'user', text);  // save the /humano message before handoff
  await executeHandoff(phone, contact, history);
  return;  // pipeline ends — bot is now in human mode
}
```

**IMPORTANT:** The handoff branch must save the user's `/humano` message and load history WITHIN the branch (before executeHandoff), then return — it does NOT fall through to the normal Q&A path.

**IMPORTANT:** The admin command check MUST be placed BEFORE `getOrCreateConversation()` and the human mode gate. If placed after, `/bot` cannot restore bot mode because the human mode gate would exit first.

3. Update the console.log at the end to reflect new step numbering.

4. Update the file header comment to reflect Phase 3.
  </action>
  <verify>
    <automated>npx tsc --noEmit --skipLibCheck 2>&1 | head -20</automated>
    <manual>Read webhook.ts and verify: (1) admin command check is BEFORE getOrCreateConversation, (2) handoff branch is AFTER classifyIntent but BEFORE loadHistory in the Q&A path, (3) /humano message is saved to history in the handoff branch</manual>
  </verify>
  <done>
- Admin command check (`isAdminCommand` + `isAdminPhone`) runs before humanMode gate — /bot can restore bot mode
- Non-admin phones sending /bot or /status get silently ignored (return without response)
- Handoff branch runs when intent === 'handoff': saves user message, loads history, calls executeHandoff, returns
- Normal Q&A path (steps 7-12) is unchanged from 03-01
- Pipeline flow is correct: parse → contact → admin check → humanMode gate → intent → handoff branch OR Q&A path
- TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --skipLibCheck` passes with zero errors
2. `src/services/conversation.ts` exports `setHumanMode`
3. `src/services/handoff.ts` exports `buildHandoffBriefing` and `executeHandoff`
4. `src/services/admin.ts` exports `isAdminPhone`, `isAdminCommand`, `handleAdminCommand`
5. `src/routes/webhook.ts` imports from admin.ts and handoff.ts
6. Admin command check appears BEFORE `getOrCreateConversation()` in processMessage
7. Handoff branch appears AFTER `classifyIntent()` and BEFORE the Q&A loadHistory
8. `isAdminCommand` returns false for `/humano` (verified by reading the function)
9. `executeHandoff` calls `sendTextMessage` BEFORE `setHumanMode(true)` (verified by reading the function)
</verification>

<success_criteria>
- Broker sends `/humano`: bot sends structured briefing with broker info and last 3 messages, then confirmation, then goes silent
- After handoff: bot does not respond to further broker messages (humanMode=true blocks at gate)
- Admin sends `/bot`: bot responds with "Bot mode restaurado" and resumes responding to broker messages
- Admin sends `/status`: bot responds with current mode, broker name, last message
- Non-admin sends `/bot`: no response (silently ignored)
- Non-admin sends `/status`: no response (silently ignored)
- `/humano` from any phone: flows through intent pipeline to handoff (NOT intercepted by admin check)
- TypeScript compiles cleanly; no runtime errors in the happy path
</success_criteria>

<output>
After completion, create `.planning/phases/03-insurance-qa-handoff/03-02-SUMMARY.md`
</output>
