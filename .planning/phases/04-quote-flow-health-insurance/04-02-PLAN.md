---
phase: 04-quote-flow-health-insurance
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/routes/webhook.ts
  - src/services/ai.ts
autonomous: true
requirements: [QUOT-01, QUOT-02, QUOT-04]

must_haves:
  truths:
    - "Broker mid-quote message (e.g. 'Sao Paulo') routes to quote flow, not to AI Q&A — active QuoteState takes priority over intent classification"
    - "New 'cotar saude' message from broker triggers fresh quote session — intent 'quote' detected by existing classifyIntent and routed to handleQuoteMessage"
    - "Broker returns after interruption and bot resumes from last collected step without restarting"
    - "User message is saved to history BEFORE routing to quote branch — no history gaps"
    - "Quote flow short-circuits the AI response path — generateResponse is NOT called when quote is active"
    - "AI system prompt for intent 'quote' no longer says 'em breve' — it redirects broker to quote flow"
  artifacts:
    - path: "src/routes/webhook.ts"
      provides: "Quote branch in processMessage pipeline — checks active QuoteState before AI response"
      contains: "handleQuoteMessage"
    - path: "src/services/ai.ts"
      provides: "Updated quote intent prompt text"
      contains: "quote"
  key_links:
    - from: "src/routes/webhook.ts"
      to: "src/services/quoteService.ts"
      via: "imports handleQuoteMessage and getQuoteState"
      pattern: "import.*handleQuoteMessage.*from.*quoteService"
    - from: "src/routes/webhook.ts"
      to: "prisma conversation state"
      via: "getQuoteState reads Conversation.state to detect active session"
      pattern: "getQuoteState"
---

<objective>
Wire the quote flow service into the webhook pipeline so that quote interactions are correctly routed — both new quote intents and mid-flow messages from active sessions.

Purpose: Plan 01 built the complete quote service. This plan connects it to the live message processing pipeline, ensuring the state machine is invoked at the right point and all edge cases (active session detection, message saving, interruptions) are handled per project invariants.

Output: Updated webhook.ts with quote branch and updated ai.ts with corrected quote intent prompt.
</objective>

<execution_context>
@/Users/felipescupino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felipescupino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quote-flow-health-insurance/04-RESEARCH.md
@.planning/phases/04-quote-flow-health-insurance/04-CONTEXT.md
@.planning/phases/04-quote-flow-health-insurance/04-01-SUMMARY.md

@src/routes/webhook.ts
@src/services/ai.ts
@src/services/quoteService.ts
@src/services/intent.ts
@src/services/history.ts
@src/services/whatsapp.ts
@src/services/conversation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire quote branch into webhook pipeline and update AI quote prompt</name>
  <files>src/routes/webhook.ts, src/services/ai.ts</files>
  <action>
**1. Update src/routes/webhook.ts** — add quote flow routing into processMessage().

Add imports at top:
```typescript
import { handleQuoteMessage, getQuoteState } from '../services/quoteService';
```

Modify the processMessage() function. The key architectural change: after the handoff branch (Step 5) and BEFORE the existing AI response path (Steps 6-11), insert a quote flow branch. The quote branch must check for active quote session BEFORE intent reclassification would send mid-flow messages to Q&A.

New step ordering (steps renumbered):

**Keep Steps 1-5 exactly as-is** (contact upsert, classifyIntent, admin check, humanMode gate, handoff branch). These are unchanged.

**Insert new Step 6: Read quote state from DB**
```typescript
// Step 6: Read active quote session (QUOT-04)
const quoteState = await getQuoteState(phone);
```

**Insert new Step 7: Quote flow branch — BEFORE loading history for AI**
This is the critical routing decision. An active quote session (status 'collecting' or 'confirming') takes PRIORITY over the classified intent. This prevents mid-flow messages like "Sao Paulo" from being routed to Q&A.

```typescript
// Step 7: Route to quote flow if active session OR new quote intent (QUOT-01, QUOT-02, QUOT-04)
// CRITICAL: Active session check comes FIRST — mid-flow messages won't have quote keywords.
// Research pitfall #1: "Sao Paulo" mid-flow must route to quote, not Q&A.
if (quoteState?.status === 'collecting' || quoteState?.status === 'confirming' || intent === 'quote') {
  // Save user message BEFORE processing (project invariant — prevents history gaps; Research pitfall #4)
  await saveMessage(phone, 'user', text);
  await handleQuoteMessage(phone, text, quoteState);
  console.log(`[webhook] Quote flow for ${phone} (step=${quoteState?.currentStep ?? 'new'}, intent=${intent})`);
  return;  // short-circuit — do NOT fall through to AI response
}
```

**Renumber existing Steps 6-11 to Steps 8-13.** Their content is unchanged — they handle non-quote messages (Q&A, greetings, unknown).

Update the file header comment to reflect Phase 4 additions.

IMPORTANT implementation notes:
- `saveMessage(phone, 'user', text)` MUST be called inside the quote branch BEFORE `handleQuoteMessage` — this is the established save-before-process pattern for the quote branch. The existing pipeline saves user messages at the old Step 7 (now Step 9), which the quote branch short-circuits.
- `handleQuoteMessage` handles sending the response message and saving the assistant message internally.
- The `return` after handleQuoteMessage prevents falling through to loadHistory and generateResponse.
- When `intent === 'quote'` AND there's already an active collecting/confirming session, the active session takes priority (CONTEXT.md: "nova cotacao substitui a anterior se nao foi concluida"). The handleQuoteMessage function handles this logic internally — it checks if a new 'cotar' intent should reset the state.

Wait — re-reading CONTEXT.md: "Uma cotacao ativa por vez — nova cotacao substitui a anterior se nao foi concluida". This means: if intent is 'quote' AND quoteState exists with status 'collecting', handleQuoteMessage should reset to fresh state. This is already handled inside handleQuoteMessage from Plan 01 (it creates fresh state when intent triggers and existing state is present).

But the webhook needs to pass the `intent` to handleQuoteMessage so it knows whether this is a new "cotar" request or a mid-flow answer. Update the handleQuoteMessage call to pass `intent`:
```typescript
await handleQuoteMessage(phone, text, quoteState, intent === 'quote');
```

Wait — Plan 01 defined `handleQuoteMessage(phone, text, existingState)` with 3 params. The intent information is needed to distinguish "new quote request" from "mid-flow answer". Two options:
- Add a 4th param `isNewQuoteIntent: boolean` to handleQuoteMessage
- Have handleQuoteMessage infer from text (re-check for quote keywords)

Better: add a 4th param. This keeps the logic clean. The executor of Plan 01 should account for this — BUT since Plan 02 depends on Plan 01, and Plan 01's summary will document the actual signature, adjust the call accordingly. If Plan 01's handleQuoteMessage takes 3 params, add the 4th param to the signature in this task.

Actually, let me reconsider. Per CONTEXT.md, "nova cotacao substitui a anterior se nao foi concluida." The simplest approach: in the webhook, when `intent === 'quote'` AND state exists with `status === 'collecting'`, pass `null` for existingState to force a fresh start. This way handleQuoteMessage's 3-param signature works unchanged:

```typescript
if (quoteState?.status === 'collecting' || quoteState?.status === 'confirming' || intent === 'quote') {
  await saveMessage(phone, 'user', text);
  // If new quote intent arrives while collecting, reset session (CONTEXT: "nova cotacao substitui")
  const stateToPass = (intent === 'quote' && quoteState?.status !== 'confirming')
    ? null  // force fresh start on new "cotar" intent
    : quoteState;
  await handleQuoteMessage(phone, text, stateToPass);
  console.log(`[webhook] Quote flow for ${phone} (step=${quoteState?.currentStep ?? 'new'}, intent=${intent})`);
  return;
}
```

This handles the edge case where broker says "quero cotar saude" again while mid-collecting — it resets. But if they say "cotar" during confirmation, we still preserve the confirming state (they might just be excited). Actually, per CONTEXT.md "nova cotacao substitui a anterior se nao foi concluida", a new cotar during confirmation should also reset. Simplify:

```typescript
const stateToPass = intent === 'quote' ? null : quoteState;
```

This way, any new "cotar" message always starts fresh, while mid-flow answers (no quote keyword) continue the existing session.

**2. Update src/services/ai.ts** — change the quote intent prompt.

In `buildSystemPrompt()`, find the quote intent branch:
```typescript
? 'O corretor esta interessado em fazer uma cotacao. Colete informacoes necessarias e informe que o fluxo completo de cotacao estara disponivel em breve.'
```

Replace with:
```typescript
? 'O corretor quer fazer uma cotacao. O fluxo de cotacao ja foi iniciado automaticamente — nao repita instrucoes de cotacao aqui.'
```

This is a safety fallback — in practice, quote intent messages should never reach generateResponse because the webhook routes them to handleQuoteMessage first. But if they somehow do (edge case), the AI won't promise "em breve" anymore.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Trace the webhook pipeline logic: verify that a message from a broker with an active QuoteState routes to handleQuoteMessage and does NOT reach generateResponse. Verify a new "cotar" message starts a fresh session. Verify saveMessage is called before handleQuoteMessage.</manual>
  </verify>
  <done>webhook.ts routes active quote sessions and new quote intents to handleQuoteMessage before the AI response path. User messages are saved to history before quote processing. Mid-flow messages (no quote keywords) correctly continue the active session. New "cotar" messages reset the session. ai.ts no longer says quote flow is "em breve". TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Trace processMessage flow: Step 7 checks quoteState before Steps 8+ (AI path)
3. `getQuoteState` is called at Step 6 (before quote branch decision)
4. `saveMessage(phone, 'user', text)` is called inside quote branch before handleQuoteMessage
5. `handleQuoteMessage` import resolves to src/services/quoteService.ts
6. ai.ts buildSystemPrompt quote branch no longer contains "em breve"
</verification>

<success_criteria>
- Active quote session (collecting/confirming) routes to handleQuoteMessage, not generateResponse
- New "cotar" intent routes to handleQuoteMessage with null state (fresh session)
- Mid-flow messages continue existing session without re-classifying intent
- User message is saved before quote processing (no history gaps)
- Quote branch short-circuits the AI response path (return after handleQuoteMessage)
- AI quote prompt updated — no "em breve" placeholder
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-quote-flow-health-insurance/04-02-SUMMARY.md`
</output>
