---
phase: 02-core-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/services/contact.ts
  - src/services/conversation.ts
autonomous: true
requirements:
  - CORE-02
  - CORE-04

must_haves:
  truths:
    - "Contact record is upserted in the database on every inbound message using the phone number as unique key"
    - "Contact name is populated from Z-API senderName on every message (always synced)"
    - "First-message detection correctly identifies newly-created contacts"
    - "Conversation record exists for every phone that messages the bot"
    - "humanMode flag on Conversation prevents further processing when a human agent has taken over"
  artifacts:
    - path: "src/services/contact.ts"
      provides: "upsertContact(), isFirstMessage() functions"
      exports: ["upsertContact", "isFirstMessage"]
    - path: "src/services/conversation.ts"
      provides: "getOrCreateConversation(), isHumanMode() functions"
      exports: ["getOrCreateConversation", "isHumanMode"]
    - path: "src/types/index.ts"
      provides: "ConversationContext type for cross-service use"
      contains: "ConversationContext"
  key_links:
    - from: "src/services/contact.ts"
      to: "prisma.contact"
      via: "prisma.contact.upsert()"
      pattern: "prisma\\.contact\\.upsert"
    - from: "src/services/conversation.ts"
      to: "prisma.conversation"
      via: "prisma.conversation.upsert()"
      pattern: "prisma\\.conversation\\.upsert"
    - from: "src/services/conversation.ts"
      to: "humanMode flag"
      via: "isHumanMode() returning conversation.humanMode"
      pattern: "humanMode"
---

<objective>
Create the contact and conversation persistence layer — the first two steps of the Phase 2 pipeline.

Purpose: Every inbound WhatsApp message must resolve to a Contact (broker identity) and Conversation (session state) before any AI processing occurs. These services provide the data that drives first-message detection, name personalization, and human-mode gating.

Output: src/services/contact.ts and src/services/conversation.ts (new), src/types/index.ts (updated with ConversationContext type).
</objective>

<execution_context>
@/Users/felipescupino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felipescupino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-pipeline/02-RESEARCH.md
@src/lib/prisma.ts
@prisma/schema.prisma
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ConversationContext type to src/types/index.ts</name>
  <files>src/types/index.ts</files>
  <action>
Create src/types/index.ts (currently missing — file did not exist in Phase 1) with the following type exports:

```typescript
// src/types/index.ts
// Shared types used across Phase 2 pipeline services

export interface ConversationContext {
  phone: string;
  contactName: string;
  isFirstMessage: boolean;
  humanMode: boolean;
}
```

This is the shared context object that the webhook orchestrator will pass between pipeline steps in Phase 3 (plan 03). Defining it here avoids circular imports between services.

Do NOT define Intent here — it is exported from src/services/intent.ts (created in plan 02) to keep intent classification self-contained.
  </action>
  <verify>
    <automated>cd /Users/felipescupino/issy-assistant && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Confirm src/types/index.ts exists and exports ConversationContext</manual>
  </verify>
  <done>src/types/index.ts exists and compiles without TypeScript errors. ConversationContext interface is exported.</done>
</task>

<task type="auto">
  <name>Task 2: Create contact and conversation services</name>
  <files>src/services/contact.ts, src/services/conversation.ts</files>
  <action>
Create src/services/contact.ts:

```typescript
// src/services/contact.ts
// Broker identity persistence — CORE-02
import { prisma } from '../lib/prisma';

/**
 * Upsert a contact by phone number, always syncing the latest senderName.
 * Returns the full Contact record including createdAt/updatedAt for first-message detection.
 */
export async function upsertContact(phone: string, senderName: string) {
  return prisma.contact.upsert({
    where: { phone },
    create: { phone, name: senderName },
    update: { name: senderName },   // always sync — broker may rename in WhatsApp
  });
}

/**
 * Detects whether this is the contact's first message.
 * Uses timestamp proximity (within 1s) instead of === comparison — two Date objects
 * with the same value are NOT === equal in JavaScript (object reference comparison).
 */
export function isFirstMessage(contact: { createdAt: Date; updatedAt: Date }): boolean {
  return Math.abs(contact.createdAt.getTime() - contact.updatedAt.getTime()) < 1000;
}
```

Create src/services/conversation.ts:

```typescript
// src/services/conversation.ts
// Conversation session state — CORE-04 foundation
import { prisma } from '../lib/prisma';

/**
 * Get or create the Conversation record for a phone number.
 * Uses no-op update so the record is created if absent, left unchanged if present.
 */
export async function getOrCreateConversation(phone: string) {
  return prisma.conversation.upsert({
    where: { phone },
    create: { phone },
    update: {},    // intentional no-op — preserve humanMode and state
  });
}

/**
 * Returns true if a human agent has taken over this conversation.
 * Must be checked BEFORE any OpenAI call to prevent bot/human double-response race condition.
 */
export function isHumanMode(conversation: { humanMode: boolean }): boolean {
  return conversation.humanMode;
}
```

Key implementation notes:
- Import path is `'../lib/prisma'` (not `'@prisma/client'` — uses the singleton)
- The `update: {}` in conversation upsert is intentional — no fields updated on existing rows
- `isFirstMessage` uses `.getTime()` comparison, not `===`, to avoid the JavaScript Date equality pitfall documented in RESEARCH.md Pitfall 2
  </action>
  <verify>
    <automated>cd /Users/felipescupino/issy-assistant && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify both files exist under src/services/ and have the correct exports</manual>
  </verify>
  <done>Both src/services/contact.ts and src/services/conversation.ts compile cleanly. upsertContact, isFirstMessage, getOrCreateConversation, and isHumanMode are all exported.</done>
</task>

</tasks>

<verification>
Run TypeScript compiler check after both tasks complete:

```bash
cd /Users/felipescupino/issy-assistant && npx tsc --noEmit
```

Expected: zero TypeScript errors. Both new service files resolve imports from `../lib/prisma` and `../config` correctly.
</verification>

<success_criteria>
1. `src/types/index.ts` exports `ConversationContext` interface
2. `src/services/contact.ts` exports `upsertContact(phone, senderName)` and `isFirstMessage(contact)` using Prisma upsert with phone as unique key
3. `src/services/conversation.ts` exports `getOrCreateConversation(phone)` and `isHumanMode(conversation)`
4. `npx tsc --noEmit` passes with zero errors
5. `isFirstMessage` uses `.getTime()` numeric comparison (not `===`) — no JavaScript Date equality bug
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-pipeline/02-01-SUMMARY.md` with:
- Files created/modified
- Key implementation decisions
- Any deviations from the plan
</output>
