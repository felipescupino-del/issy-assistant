---
phase: 01-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/index.ts
  - src/routes/webhook.ts
  - src/services/whatsapp.ts
autonomous: false
requirements: []

must_haves:
  truths:
    - "Running npm run dev starts the Express server and logs a health check response at /health"
    - "A test WhatsApp message from a dev phone reaches the webhook endpoint and is logged to console (no processing yet)"
    - "The dev phone number is a Z-API instance separate from any production number — confirmed by the ZAPI_INSTANCE_ID config"
    - "fromMe messages received at the webhook are silently dropped and not processed"
  artifacts:
    - path: "src/index.ts"
      provides: "Express server entry point with health check, Prisma connectivity test, webhook route"
      exports: []
    - path: "src/routes/webhook.ts"
      provides: "POST /whatsapp-webhook handler that acknowledges immediately and logs parsed payload"
      exports: ["default (router)"]
    - path: "src/services/whatsapp.ts"
      provides: "sendTextMessage function using Z-API REST API"
      exports: ["sendTextMessage"]
  key_links:
    - from: "src/routes/webhook.ts"
      to: "parseZApiPayload"
      via: "import from src/types/zapi.ts"
      pattern: "parseZApiPayload"
    - from: "src/services/whatsapp.ts"
      to: "https://api.z-api.io/instances/.../send-text"
      via: "axios.post with Client-Token header"
      pattern: "z-api.io.*send-text"
    - from: "src/index.ts"
      to: "prisma.$connect"
      via: "startup connectivity check before listen()"
      pattern: "prisma\\.\\$queryRaw|prisma\\.\\$connect"
---

<objective>
Rewrite the Express entry point and webhook handler to use Prisma + Z-API. Create the Z-API send-text service. Delete all legacy Evolution API / pg references from src/index.ts, src/routes/webhook.ts, and replace whatsapp.service.ts with whatsapp.ts. End with a human-verify checkpoint confirming a real WhatsApp message arrives at the webhook.

Purpose: This is the final infrastructure task — getting a real WhatsApp message to hit the endpoint and be logged closes the loop on Phase 1.
Output: Working Express server that receives Z-API webhooks and logs them, ready for Phase 2 processing logic.
</objective>

<execution_context>
@/Users/felipescupino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felipescupino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite src/index.ts and create src/services/whatsapp.ts</name>
  <files>
    src/index.ts
    src/services/whatsapp.ts
  </files>
  <action>
    **src/index.ts** — Complete rewrite. Remove all db.query (pg Pool), adminRouter import and registration, legacy imports. Add Prisma connectivity test at startup. Keep the /health endpoint. Register only the webhook route for now (admin route is Phase 3).

    ```typescript
    import 'dotenv/config';
    import express from 'express';
    import { config } from './config';
    import { prisma } from './lib/prisma';
    import webhookRouter from './routes/webhook';

    const app = express();

    app.use(express.json({ limit: '5mb' }));

    // Health check
    app.get('/health', (_req, res) => {
      res.json({ status: 'ok', service: 'issy-assistant', timestamp: new Date().toISOString() });
    });

    // Routes
    app.use('/whatsapp-webhook', webhookRouter);

    // 404 handler
    app.use((_req, res) => {
      res.status(404).json({ error: 'Rota não encontrada' });
    });

    async function start(): Promise<void> {
      // Test database connectivity before accepting traffic
      await prisma.$queryRaw`SELECT 1`;
      console.log('[DB] Conectado ao PostgreSQL via Prisma.');

      app.listen(config.port, () => {
        console.log(`[Server] Issy Assistant rodando na porta ${config.port}`);
        console.log(`[Server] Health:  GET  http://localhost:${config.port}/health`);
        console.log(`[Server] Webhook: POST http://localhost:${config.port}/whatsapp-webhook`);
      });
    }

    start().catch((err) => {
      console.error('[Server] Falha ao iniciar:', err.message);
      process.exit(1);
    });
    ```

    **src/services/whatsapp.ts** — New file (the old whatsapp.service.ts used Evolution API; this replaces it entirely). Do NOT delete whatsapp.service.ts yet — rename it conceptually by creating the new file. The old file will be cleaned up at end of this task.

    ```typescript
    // src/services/whatsapp.ts
    // Z-API send-text service
    // Source: https://developer.z-api.io/en/message/send-message-text

    import axios from 'axios';
    import { config } from '../config';

    /**
     * Send a plain text message via Z-API.
     * @param phone - E.164 digits-only format, e.g. "5511999999999"
     * @param message - Plain text message body
     */
    export async function sendTextMessage(phone: string, message: string): Promise<void> {
      const { instanceId, instanceToken, clientToken } = config.zapi;

      await axios.post(
        `https://api.z-api.io/instances/${instanceId}/token/${instanceToken}/send-text`,
        { phone, message },
        {
          headers: { 'Client-Token': clientToken },
          timeout: 10_000,
        },
      );
    }
    ```

    After writing both files, delete the old files that are now replaced:
    - Delete src/services/whatsapp.service.ts (replaced by whatsapp.ts)
    - Delete src/routes/admin.ts (will be rebuilt in Phase 3; no admin logic in Phase 1)
    - Delete src/db/client.ts (replaced by src/lib/prisma.ts)
    - Delete src/db/migrations/001_initial.sql (replaced by Prisma migrations)

    Keep intact (do not modify yet):
    - src/types/index.ts (legacy types — leave for Phase 2 cleanup)
    - src/services/*.service.ts other files (ai, contact, etc. — leave for Phase 2 rewrite)
  </action>
  <verify>
    <automated>cd /Users/felipescupino/issy-assistant && npx tsc --noEmit --skipLibCheck 2>&1 | head -30</automated>
    <manual>Confirm src/services/whatsapp.ts exists and src/services/whatsapp.service.ts is deleted. Confirm src/index.ts imports from ./lib/prisma not ./db/client. Confirm src/routes/admin.ts is deleted.</manual>
  </verify>
  <done>TypeScript compiles src/index.ts and src/services/whatsapp.ts without errors. Legacy pg and Evolution API imports are absent from index.ts. whatsapp.ts exports sendTextMessage using Z-API endpoint.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite src/routes/webhook.ts for Z-API payload and start dev server</name>
  <files>src/routes/webhook.ts</files>
  <action>
    **src/routes/webhook.ts** — Complete rewrite. Use the acknowledge-then-process pattern. For Phase 1, processMessage just logs the parsed payload — no AI, no DB writes, no sending. This is intentional: Phase 2 adds the full pipeline.

    ```typescript
    // src/routes/webhook.ts
    // Phase 1: Receive Z-API webhooks, acknowledge immediately, log parsed payload.
    // Message processing logic is added in Phase 2.

    import { Router } from 'express';
    import { parseZApiPayload, ZApiWebhookPayload } from '../types/zapi';

    const router = Router();

    router.post('/', (req, res) => {
      // Acknowledge immediately — Z-API expects a fast 2xx response
      res.json({ status: 'received' });

      // Async processing (currently just logging — Phase 2 adds pipeline)
      processMessage(req.body as ZApiWebhookPayload).catch((err) =>
        console.error('[webhook] Erro ao processar mensagem:', err.message),
      );
    });

    async function processMessage(body: ZApiWebhookPayload): Promise<void> {
      const parsed = parseZApiPayload(body);

      if (!parsed) {
        // fromMe or group message — silently ignore
        return;
      }

      // Phase 1: Log the received message for verification
      console.log('[webhook] Mensagem recebida:', {
        phone:      parsed.phone,
        senderName: parsed.senderName,
        text:       parsed.text,
        messageId:  parsed.messageId,
        timestamp:  parsed.timestamp.toISOString(),
      });

      // Phase 2 will add: contact upsert, conversation lookup, intent detection, AI response
    }

    export default router;
    ```

    After writing the file, start the dev server and test it:
    ```bash
    npm run dev
    ```

    In a separate terminal, confirm the health check works:
    ```bash
    curl http://localhost:3000/health
    ```

    Expected response: `{"status":"ok","service":"issy-assistant","timestamp":"..."}`

    If the server fails to start, the most likely cause is missing env vars — check that .env has all required values (DATABASE_URL, DIRECT_URL, ZAPI_INSTANCE_ID, ZAPI_INSTANCE_TOKEN, ZAPI_CLIENT_TOKEN, OPENAI_API_KEY).

    Also set up cloudflared tunnel for the human-verify task:
    ```bash
    # If not installed:
    brew install cloudflare/cloudflare/cloudflared

    # Start a temporary tunnel (no account required):
    cloudflared tunnel --url http://localhost:3000
    ```

    Copy the generated HTTPS URL (e.g., https://xxxx-xxxx.trycloudflare.com). This is the webhook URL to configure in Z-API.
  </action>
  <verify>
    <automated>curl -s http://localhost:3000/health 2>/dev/null || echo "Server not running — start with npm run dev first"</automated>
    <manual>Run `npm run dev` and confirm: (1) "[DB] Conectado ao PostgreSQL via Prisma." log line appears, (2) curl http://localhost:3000/health returns {"status":"ok",...}</manual>
  </verify>
  <done>npm run dev starts without error. Health check returns 200. Prisma connectivity log line appears. Webhook route is registered at POST /whatsapp-webhook.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verify — real WhatsApp message reaches webhook</name>
  <action>Human verification gate. No files are created by Claude at this step. Claude has automated Tasks 1 and 2; the user now confirms the full webhook loop works with a real device.</action>
  <what-built>
    Express server running at localhost:3000 with:
    - GET /health → returns {"status":"ok"}
    - POST /whatsapp-webhook → acknowledges immediately, logs parsed Z-API payload
    - cloudflared tunnel exposing localhost:3000 to a public HTTPS URL
  </what-built>
  <how-to-verify>
    1. Confirm npm run dev is running and shows the Prisma connect log.
    2. Confirm cloudflared tunnel is running and you have the HTTPS URL (e.g., https://xxxx.trycloudflare.com).
    3. Configure Z-API webhook:
       - Go to Z-API Dashboard -> Instances -> your instance -> Webhooks
       - Set the "Received" webhook URL to: https://xxxx.trycloudflare.com/whatsapp-webhook
       - Save the webhook configuration
    4. Send a WhatsApp text message FROM the connected Z-API phone number TO itself, or from another phone TO the Z-API number.
    5. Check the terminal running npm run dev. You should see a log line like:
       ```
       [webhook] Mensagem recebida: { phone: '5511999999999', senderName: 'Your Name', text: 'hello', ... }
       ```
    6. Verify a message sent BY the bot (fromMe=true) does NOT appear in the logs.

    Phase 1 success criteria from ROADMAP.md:
    - [x] npm run dev starts and logs health check — confirmed in Task 2
    - [x] Test WhatsApp message reaches webhook and is logged — confirm now
    - [x] Database has all tables (contatos, conversas, mensagens) — confirmed in Plan 02
    - [x] Dev phone is separate from production — Z-API instance = separate account
  </how-to-verify>
  <verify>Terminal running npm run dev shows "[webhook] Mensagem recebida:" log line with phone, senderName, and text fields populated</verify>
  <done>Real WhatsApp message from dev phone appears in server logs at /whatsapp-webhook. fromMe messages are not logged. Phase 1 roadmap success criteria 1–4 are all met.</done>
  <resume-signal>Type "approved" when the webhook log line appears in the terminal, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 complete when all four roadmap success criteria are met:
1. `npm run dev` starts server, "[DB] Conectado ao PostgreSQL via Prisma." appears — AUTOMATED
2. Test WhatsApp message arrives and is logged at /whatsapp-webhook — HUMAN VERIFIED
3. `npx prisma migrate status` → "All migrations have been applied." — AUTOMATED (Plan 02)
4. Dev phone number is a separate Z-API instance from production — CONFIRMED by config inspection (ZAPI_INSTANCE_ID is per-instance)
</verification>

<success_criteria>
- src/index.ts: imports prisma singleton, no pg Pool, /health endpoint, server starts cleanly
- src/routes/webhook.ts: acknowledges immediately, calls parseZApiPayload, logs result, silently drops fromMe
- src/services/whatsapp.ts: sendTextMessage function using Z-API REST with Client-Token header
- Legacy files deleted: src/services/whatsapp.service.ts, src/routes/admin.ts, src/db/client.ts, src/db/migrations/001_initial.sql
- npm run dev starts without errors and connects to Supabase
- Real WhatsApp message logged at the webhook endpoint (human verified)
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-03-SUMMARY.md` following the summary template.
</output>
