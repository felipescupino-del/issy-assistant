---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - prisma/schema.prisma
autonomous: true
requirements: []

must_haves:
  truths:
    - "prisma migrate status reports all migrations applied with no pending migrations"
    - "Supabase dashboard shows four tables: contatos, conversas, mensagens, and _prisma_migrations"
    - "Prisma client is regenerated and types for Contact, Conversation, Message models are available"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Complete schema with Contact, Conversation, Message models; Portuguese @@map names; JSONB state on Conversation"
      contains: "model Contact"
    - path: "prisma/migrations/"
      provides: "Auto-generated migration SQL tracking schema state"
  key_links:
    - from: "prisma/schema.prisma"
      to: "Supabase PostgreSQL"
      via: "prisma migrate dev using DIRECT_URL"
      pattern: "directUrl.*DIRECT_URL"
    - from: "Contact model"
      to: "contatos table"
      via: "@@map(\"contatos\")"
      pattern: "@@map\\(\"contatos\"\\)"
    - from: "Conversation.state"
      to: "Json? @map(\"estado\")"
      via: "JSONB column for quote flow state"
      pattern: "state.*Json"
---

<objective>
Define the complete Prisma schema for all conversation state tables and run the initial migration to Supabase. All four conceptual tables from the roadmap success criteria are created: contacts (contatos), conversations (conversas), messages (mensagens), and conversation state (estado JSONB column on conversas — not a separate table, per Claude's discretion).

Purpose: The database schema is the source of truth for all Phase 2–5 features. Getting it right in Phase 1 avoids disruptive schema changes mid-feature development.
Output: prisma/schema.prisma with all models, prisma/migrations/ with applied migration
</objective>

<execution_context>
@/Users/felipescupino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felipescupino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Prisma schema with all conversation state models</name>
  <files>prisma/schema.prisma</files>
  <action>
    Overwrite prisma/schema.prisma completely with the following content. English model names, Portuguese table/column names via @map and @@map. Use directUrl for Supabase migration compatibility. Quote state stored as JSONB column on Conversation (not a separate table — simpler for v1, fully supports Phase 4 quote flow).

    ```prisma
    // prisma/schema.prisma
    // Model names: English (PascalCase)
    // Table/column names: Portuguese (snake_case) via @@map / @map

    datasource db {
      provider  = "postgresql"
      url       = env("DATABASE_URL")
      directUrl = env("DIRECT_URL")
    }

    generator client {
      provider = "prisma-client-js"
    }

    // ─── Contact ──────────────────────────────────────────────────────────────
    // Represents a WhatsApp user (broker). Identified by phone number.
    model Contact {
      id        Int       @id @default(autoincrement())
      phone     String    @unique @map("telefone")
      name      String    @default("Desconhecido") @map("nome")
      createdAt DateTime  @default(now()) @map("criado_em")
      updatedAt DateTime  @updatedAt @map("atualizado_em")

      messages  Message[]

      @@map("contatos")
    }

    // ─── Conversation ─────────────────────────────────────────────────────────
    // One row per phone number. Tracks human-mode flag and quote flow state (JSONB).
    // quote flow state (campo `estado`) stores the current quote collection progress as JSON.
    // Separate from messages so it can be updated independently without touching message history.
    model Conversation {
      id        Int      @id @default(autoincrement())
      phone     String   @unique @map("telefone")
      humanMode Boolean  @default(false) @map("modo_humano")
      state     Json?    @map("estado")         // Quote flow state — JSONB, null when no active flow
      updatedAt DateTime @updatedAt @map("atualizado_em")

      @@map("conversas")
    }

    // ─── Message ──────────────────────────────────────────────────────────────
    // Full message history. Role is "user" (broker) or "assistant" (bot).
    // All messages are stored; LLM receives only the last N (HISTORY_LIMIT env var).
    model Message {
      id        Int      @id @default(autoincrement())
      phone     String   @map("telefone")
      role      String   @map("papel")      // "user" | "assistant"
      content   String   @map("conteudo")
      createdAt DateTime @default(now()) @map("criado_em")

      contact   Contact  @relation(fields: [phone], references: [phone])

      @@index([phone], name: "idx_mensagens_telefone")
      @@index([createdAt], name: "idx_mensagens_criado_em")
      @@map("mensagens")
    }
    ```

    After writing this file, verify it parses correctly:
    ```bash
    npx prisma validate
    ```
  </action>
  <verify>
    <automated>cd /Users/felipescupino/issy-assistant && npx prisma validate 2>&1</automated>
    <manual>Confirm prisma/schema.prisma contains three model blocks: Contact, Conversation, Message. Confirm directUrl = env("DIRECT_URL") is present in datasource block.</manual>
  </verify>
  <done>npx prisma validate exits cleanly with no errors. Schema contains Contact, Conversation, Message models with correct Portuguese @@map names.</done>
</task>

<task type="auto">
  <name>Task 2: Run initial Prisma migration against Supabase</name>
  <files>prisma/migrations/</files>
  <action>
    Run the Prisma migration to apply the schema to the Supabase database. This requires DATABASE_URL and DIRECT_URL to be set in .env (user set these in Plan 01 Task 1).

    ```bash
    npx prisma migrate dev --name init
    ```

    This command will:
    1. Connect to Supabase via DIRECT_URL (bypasses pooler — required for migration)
    2. Create the migration SQL in prisma/migrations/TIMESTAMP_init/migration.sql
    3. Apply the migration to the database
    4. Run `prisma generate` automatically to regenerate the client

    After the migration succeeds, verify the migration status:
    ```bash
    npx prisma migrate status
    ```

    Expected output: "All migrations have been applied."

    If the command hangs or fails with a connection error, check:
    - DIRECT_URL points to db.PROJECT_REF.supabase.co (not the pooler host)
    - DIRECT_URL uses port 5432
    - The Supabase project is fully provisioned (check Supabase dashboard)

    Do NOT run `prisma db push` — use `prisma migrate dev` so the migration is tracked.
  </action>
  <verify>
    <automated>cd /Users/felipescupino/issy-assistant && npx prisma migrate status 2>&1</automated>
    <manual>Check Supabase dashboard -> Table Editor. Confirm tables exist: contatos, conversas, mensagens, _prisma_migrations. Confirm the migration file exists at prisma/migrations/*/migration.sql.</manual>
  </verify>
  <done>npx prisma migrate status reports "All migrations have been applied." Four tables visible in Supabase dashboard. prisma/migrations/ directory contains at least one migration folder.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx prisma validate` exits cleanly
2. `npx prisma migrate status` reports all migrations applied
3. Supabase Table Editor shows: contatos, conversas, mensagens (plus _prisma_migrations system table)
4. `npx tsc --noEmit --skipLibCheck` still passes (Prisma client regenerated with correct types)
5. `ls prisma/migrations/` shows at least one timestamped directory
</verification>

<success_criteria>
- prisma/schema.prisma: three models (Contact, Conversation, Message), Portuguese table/column names, directUrl set
- prisma/migrations/: one migration folder created and applied
- Supabase database: contatos, conversas, mensagens tables exist
- Prisma client types regenerated — TypeScript knows about Contact, Conversation, Message models
- `npx prisma migrate status`: "All migrations have been applied."
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md` following the summary template.
</output>
