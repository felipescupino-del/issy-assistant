---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config.ts
  - src/lib/prisma.ts
  - src/types/zapi.ts
  - .env.example
autonomous: false
requirements: []

must_haves:
  truths:
    - "npm install succeeds with prisma as dev dep and @prisma/client as runtime dep, pg removed"
    - "Running the app fails fast at startup if any required env var is missing (ZAPI_INSTANCE_ID, ZAPI_INSTANCE_TOKEN, ZAPI_CLIENT_TOKEN, DATABASE_URL, DIRECT_URL, OPENAI_API_KEY)"
    - "PrismaClient singleton is importable from src/lib/prisma.ts without error"
    - "ZApiWebhookPayload TypeScript interface compiles cleanly with the momment typo documented"
  artifacts:
    - path: "src/config.ts"
      provides: "Validated env var config object with zapi, database, openai, app sections"
      exports: ["config"]
    - path: "src/lib/prisma.ts"
      provides: "PrismaClient singleton"
      exports: ["prisma"]
    - path: "src/types/zapi.ts"
      provides: "Z-API webhook payload type + parseZApiPayload helper"
      exports: ["ZApiWebhookPayload", "parseZApiPayload"]
    - path: ".env.example"
      provides: "All required env var keys with placeholder values and comments"
  key_links:
    - from: "src/lib/prisma.ts"
      to: "DATABASE_URL"
      via: "PrismaClient() reads env var at construction time"
      pattern: "new PrismaClient"
    - from: "src/config.ts"
      to: "ZAPI_INSTANCE_ID"
      via: "required() helper throws at startup"
      pattern: "required\\('ZAPI_INSTANCE_ID'\\)"

user_setup:
  - service: supabase
    why: "PostgreSQL cloud database for all conversation state"
    env_vars:
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project -> Settings -> Database -> Connection Pooling -> Session mode (port 5432) -> Connection string"
      - name: DIRECT_URL
        source: "Supabase Dashboard -> Project -> Settings -> Database -> Direct connection -> Connection string (port 5432, host db.[PROJECT-REF].supabase.co)"
    dashboard_config:
      - task: "Create a new Supabase project (free tier)"
        location: "https://supabase.com/dashboard -> New project"
  - service: z-api
    why: "WhatsApp messaging provider for sending and receiving messages"
    env_vars:
      - name: ZAPI_INSTANCE_ID
        source: "Z-API Dashboard -> Instances -> select instance -> Instance ID"
      - name: ZAPI_INSTANCE_TOKEN
        source: "Z-API Dashboard -> Instances -> select instance -> Token"
      - name: ZAPI_CLIENT_TOKEN
        source: "Z-API Dashboard -> Account -> Security -> Client Token"
    dashboard_config:
      - task: "Create a Z-API account and connect a WhatsApp number (use a dev number, NOT a production number)"
        location: "https://z-api.io"
  - service: openai
    why: "AI completions — needed by later phases, required at startup"
    env_vars:
      - name: OPENAI_API_KEY
        source: "https://platform.openai.com/api-keys"
---

<objective>
Replace legacy pg + Evolution API dependencies with Prisma + Z-API. Set up the typed config, PrismaClient singleton, and Z-API type definitions that all subsequent plans and phases depend on.

Purpose: This is the foundation layer. Every other file in the project imports from config.ts, prisma.ts, or zapi.ts. Getting these right prevents cascading type errors and runtime surprises.
Output: package.json with correct deps, src/config.ts with Z-API config, src/lib/prisma.ts singleton, src/types/zapi.ts, .env.example
</objective>

<execution_context>
@/Users/felipescupino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felipescupino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Prerequisites — Supabase project and Z-API instance</name>
  <action>Human-only prerequisite gate. No files are created by Claude. The user must create external service accounts and populate .env before Tasks 2 and 3 can run successfully.</action>
  <what-built>Nothing yet — this gate ensures the credentials exist before code is written that requires them.</what-built>
  <how-to-verify>
    1. Create a Supabase project at https://supabase.com/dashboard (free tier). Copy both connection strings:
       - SESSION POOLER URL: Dashboard -> Settings -> Database -> Connection Pooling -> Session mode (port 5432)
       - DIRECT URL: Dashboard -> Settings -> Database -> Direct connection (port 5432, host db.PROJECT_REF.supabase.co)
    2. Create a Z-API account at https://z-api.io and connect a WhatsApp number (dev number only — NOT production). Copy:
       - ZAPI_INSTANCE_ID: Instances -> select instance -> Instance ID
       - ZAPI_INSTANCE_TOKEN: Instances -> select instance -> Token
       - ZAPI_CLIENT_TOKEN: Account -> Security -> Client Token
    3. Have your OPENAI_API_KEY ready from https://platform.openai.com/api-keys
    4. Create a .env file in the project root with all six values filled in (use .env.example as template after Task 2 writes it).
  </how-to-verify>
  <verify>User confirms .env file exists with all six credentials populated</verify>
  <done>.env file contains non-placeholder values for DATABASE_URL, DIRECT_URL, ZAPI_INSTANCE_ID, ZAPI_INSTANCE_TOKEN, ZAPI_CLIENT_TOKEN, OPENAI_API_KEY</done>
  <resume-signal>Type "ready" when .env is populated with real credentials</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Install Prisma, remove pg, rewrite package.json scripts</name>
  <files>package.json</files>
  <action>
    Run the following commands in the project root:

    ```bash
    npm uninstall pg @types/pg
    npm install --save-dev prisma
    npm install @prisma/client
    npx prisma init --datasource-provider postgresql
    ```

    After running these, update the `scripts` section of package.json to replace the legacy `db:migrate` script:
    - Remove: `"db:migrate": "psql $DATABASE_URL -f src/db/migrations/001_initial.sql"`
    - Add: `"db:migrate": "npx prisma migrate dev"`
    - Add: `"db:generate": "npx prisma generate"`
    - Add: `"db:status": "npx prisma migrate status"`

    Do NOT delete or move any existing src/ files yet — that happens in Task 3.

    The `npx prisma init` command creates prisma/schema.prisma with a placeholder datasource. Plan 02 will overwrite this with the real schema.
  </action>
  <verify>
    <automated>node -e "const p = require('./node_modules/@prisma/client'); console.log('ok')" && ls prisma/schema.prisma</automated>
    <manual>Verify pg and @types/pg are absent from package.json dependencies. Verify prisma is in devDependencies and @prisma/client is in dependencies.</manual>
  </verify>
  <done>@prisma/client is importable, prisma/ directory exists with schema.prisma, pg is absent from package.json</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite config.ts, create prisma.ts singleton, create zapi types, write .env.example</name>
  <files>
    src/config.ts
    src/lib/prisma.ts
    src/types/zapi.ts
    .env.example
  </files>
  <action>
    **src/config.ts** — Complete rewrite. Remove all Evolution API, Meta API, and WHATSAPP_PROVIDER config. Add Z-API config block. Keep openai, app (delay + history), and port sections.

    ```typescript
    import dotenv from 'dotenv';
    dotenv.config();

    function required(key: string): string {
      const value = process.env[key];
      if (!value) throw new Error(`Variável de ambiente obrigatória ausente: ${key}`);
      return value;
    }

    function optional(key: string, defaultValue = ''): string {
      return process.env[key] ?? defaultValue;
    }

    export const config = {
      port: parseInt(optional('PORT', '3000'), 10),

      database: {
        url: required('DATABASE_URL'),
      },

      zapi: {
        instanceId:    required('ZAPI_INSTANCE_ID'),
        instanceToken: required('ZAPI_INSTANCE_TOKEN'),
        clientToken:   required('ZAPI_CLIENT_TOKEN'),
      },

      openai: {
        apiKey:      required('OPENAI_API_KEY'),
        model:       optional('OPENAI_MODEL', 'gpt-4o-mini'),
        temperature: parseFloat(optional('OPENAI_TEMPERATURE', '0.85')),
        maxTokens:   parseInt(optional('OPENAI_MAX_TOKENS', '500'), 10),
      },

      app: {
        humanDelayMinMs: parseInt(optional('HUMAN_DELAY_MIN_MS', '1500'), 10),
        humanDelayMaxMs: parseInt(optional('HUMAN_DELAY_MAX_MS', '3000'), 10),
        historyLimit:    parseInt(optional('HISTORY_LIMIT', '20'), 10),
      },

      admin: {
        phoneNumbers: optional('ADMIN_PHONE_NUMBERS', '').split(',').filter(Boolean),
      },
    };
    ```

    **src/lib/prisma.ts** — Create the directory src/lib/ if it doesn't exist, then create the file:

    ```typescript
    import { PrismaClient } from '@prisma/client';

    const globalForPrisma = global as unknown as { prisma: PrismaClient };

    export const prisma =
      globalForPrisma.prisma ??
      new PrismaClient({
        log: ['error'],
      });

    if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
    ```

    **src/types/zapi.ts** — Create this file (delete or replace src/types/index.ts content later in Plan 03 when routes are rewritten; for now just add zapi.ts alongside):

    ```typescript
    // Z-API webhook payload types
    // Source: https://developer.z-api.io/en/webhooks/on-message-received

    export interface ZApiWebhookPayload {
      instanceId: string;
      messageId: string;
      phone: string;           // sender phone number — e.g., "5511999999999" (E.164, digits only)
      fromMe: boolean;         // true if the connected WhatsApp number sent this — ALWAYS filter out
      senderName: string;      // display name of the sender
      chatName: string;        // group or contact chat name
      momment: number;         // unix timestamp in ms — note: intentional typo in Z-API API
      status: string;          // "RECEIVED" | "SENT" | "READ" | "PLAYED" etc.
      isGroup: boolean;        // true for group messages — ignore group messages in v1
      type: string;            // "ReceivedCallback"
      text?: {
        message: string;       // the actual text body
      };
      image?: { caption?: string; imageUrl: string };
      audio?: { audioUrl: string; ptt: boolean };
    }

    export interface ParsedZApiMessage {
      phone: string;
      text: string | null;
      senderName: string;
      messageId: string;
      fromMe: boolean;
      isGroup: boolean;
      timestamp: Date;
    }

    /**
     * Extract the fields we care about from a raw Z-API webhook payload.
     * Returns null if the message should be ignored (fromMe or group message).
     */
    export function parseZApiPayload(body: ZApiWebhookPayload): ParsedZApiMessage | null {
      if (body.fromMe) return null;   // never process messages sent by the bot itself
      if (body.isGroup) return null;  // v1 ignores group messages

      return {
        phone:       body.phone,
        text:        body.text?.message ?? null,
        senderName:  body.senderName ?? body.chatName ?? 'Desconhecido',
        messageId:   body.messageId,
        fromMe:      body.fromMe,
        isGroup:     body.isGroup,
        timestamp:   new Date(body.momment),
      };
    }
    ```

    **.env.example** — Complete rewrite with all required keys and documentation comments:

    ```
    # ── Server ────────────────────────────────────────────────────────────────
    PORT=3000

    # ── Database (Supabase PostgreSQL) ────────────────────────────────────────
    # Session pooler URL — used for runtime queries (Connection Pooling, Session mode, port 5432)
    DATABASE_URL="postgres://prisma.[PROJECT-REF]:[PASSWORD]@[REGION].pooler.supabase.com:5432/postgres"
    # Direct connection URL — used ONLY by prisma migrate (bypasses pooler)
    DIRECT_URL="postgresql://postgres:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres"

    # ── Z-API WhatsApp Provider ────────────────────────────────────────────────
    # All three values are required. Get them from your Z-API Dashboard.
    # IMPORTANT: Use a DEV phone number — not your production number.
    ZAPI_INSTANCE_ID=your-instance-id
    ZAPI_INSTANCE_TOKEN=your-instance-token
    ZAPI_CLIENT_TOKEN=your-client-token

    # ── OpenAI ────────────────────────────────────────────────────────────────
    OPENAI_API_KEY=sk-...
    OPENAI_MODEL=gpt-4o-mini
    OPENAI_TEMPERATURE=0.85
    OPENAI_MAX_TOKENS=500

    # ── App Behaviour ─────────────────────────────────────────────────────────
    # Delay before responding (simulates typing indicator)
    HUMAN_DELAY_MIN_MS=1500
    HUMAN_DELAY_MAX_MS=3000
    # How many messages to send to OpenAI as conversation history
    HISTORY_LIMIT=20

    # ── Admin ─────────────────────────────────────────────────────────────────
    # Comma-separated list of phone numbers that can send admin commands (/bot, /status, /humano)
    ADMIN_PHONE_NUMBERS=5511999999999
    ```

    Create src/lib/ directory before writing src/lib/prisma.ts (use `mkdir -p src/lib` via Bash).
  </action>
  <verify>
    <automated>cd /Users/felipescupino/issy-assistant && npx tsc --noEmit --skipLibCheck 2>&1 | head -20</automated>
    <manual>Verify src/lib/prisma.ts exists. Verify src/types/zapi.ts exports parseZApiPayload. Verify config.ts has zapi section and no evolution/meta fields. Verify .env.example has DATABASE_URL, DIRECT_URL, and all three ZAPI_ vars.</manual>
  </verify>
  <done>TypeScript compiles without errors on the new files. config.ts exports a config object with a zapi block. src/lib/prisma.ts exports the prisma singleton. src/types/zapi.ts exports ZApiWebhookPayload interface and parseZApiPayload function.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm install` runs cleanly — no pg or @types/pg in node_modules
2. `npx tsc --noEmit --skipLibCheck` produces no errors on src/config.ts, src/lib/prisma.ts, src/types/zapi.ts
3. `ls prisma/schema.prisma` confirms Prisma was initialized
4. .env.example contains all 9 required keys (DATABASE_URL, DIRECT_URL, ZAPI_INSTANCE_ID, ZAPI_INSTANCE_TOKEN, ZAPI_CLIENT_TOKEN, OPENAI_API_KEY, PORT, HUMAN_DELAY_MIN_MS, HISTORY_LIMIT)
</verification>

<success_criteria>
- pg uninstalled, prisma + @prisma/client installed
- src/config.ts: zapi.{instanceId, instanceToken, clientToken} required, no evolution/meta fields
- src/lib/prisma.ts: PrismaClient singleton exported as `prisma`
- src/types/zapi.ts: ZApiWebhookPayload + parseZApiPayload exported and typed
- .env.example: all env vars documented with instructions
- TypeScript compiles the new files without error
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md` following the summary template.
</output>
